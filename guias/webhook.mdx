# Documentação do Payload de Webhooks (Para Clientes)

Este documento descreve a estrutura JSON dos payloads de webhook enviados pelo sistema de Fidelidade para o seu endpoint registrado quando eventos específicos ocorrem.

---

## Índice

- [Estrutura Base do Webhook](#estrutura-base-do-webhook)
- [Objetos de Dados Comuns](#objetos-de-dados-comuns)
  - [Objeto Cliente](#objeto-cliente-customer-object)
  - [Objeto Saldo de Pontos](#objeto-saldo-de-pontos-points-balance-object)
- [Definições de Enum](#definições-de-enum)
  - [CouponType](#coupontype-inteiro)
  - [ObjectiveType](#objectivetype-inteiro)
  - [PointType](#pointtype-inteiro)
  - [PointAction](#pointaction-inteiro)
- [Garantias de Entrega & Retentativas](#garantias-de-entrega--retentativas-de-webhook)
- [Personalização](#personalização)
- [Considerações de Segurança](#considerações-de-segurança)
- [Lista de Todos os Tópicos Disponíveis](#lista-de-todos-os-tópicos-disponíveis)
- [Payloads de Evento por Tópico](#payloads-de-evento-por-tópico)
  - [Cupons](#tópico-communication_couponstouse)
  - [Resgate de Recompensas](#tópico-communication_rewardcustomredeemnotification)
  - [Ganho de Pontos](#tópicos-para-comunicações-de-ganho-de-pontos)
  - [Alteração de Pontos](#tópico-communication_customerpointchangenotification)
  - [Pontos para Uso](#tópico-communication_pointstouse)
  - [Expiração de Pontos](#tópico-communication_notifyexpirablepoints)
  - [Resgate de Pontos](#tópico-communication_redeempoints)
  - [OTP](#tópico-communication_sentotptocustomer)
  - [Níveis/Tiers](#tópicos-communication_customertierupgradenotification-communication_customertierdowngradenotification)
  - [Transações de Pontos](#tópicos-para-transações-diretas-de-pontos)
  - [Pedidos](#tópicos-para-pedidos)

---

## Estrutura Base do Webhook

Todas as notificações de webhook entregues ao seu endpoint seguirão este formato JSON básico:

```json
{
  "Uuid": "uma_string_identificadora_unica",
  "Timestamp": "2025-04-15T14:30:00Z",
  "Topic": "Nome_Real_Do_Topico",
  "Payload": { ... }
}
```

| Campo | Tipo | Descrição |
|-------|------|-----------|
| `Uuid` | `string` | Identificador único (UUID) para esta tentativa de entrega. Use para idempotência. *Ex:* `"f47ac10b-58cc-4372-a567-0e02b2c3d479"` |
| `Timestamp` | `string` | Data e hora (ISO 8601, UTC) em que o evento ocorreu. *Ex:* `"2025-04-15T14:30:00.123Z"` |
| `Topic` | `string` | Tipo de evento que ocorreu. Determina a estrutura do `Payload`. *Ex:* `"Communication_EarnPurchasePoints"` |
| `Payload` | `object` | Objeto JSON com os detalhes específicos do evento. A estrutura varia conforme o `Topic`. |

---

## Objetos de Dados Comuns

Estes objetos JSON aparecem frequentemente dentro de diferentes estruturas de `Payload`:

### Objeto Cliente (Customer Object)

Contém informações sobre o cliente relacionado ao evento.

```json
{
  "Email": "cliente@exemplo.com",
  "Id": "id_original_cliente_123",
  "Name": "João Silva",
  "Phone": "+5511999998888",
  "Document": "12345678900",
  "BirthdayDate": "1990-05-20T00:00:00Z",
  "PointsBalance": 1500
}
```

| Campo | Tipo | Descrição |
|-------|------|-----------|
| `Email` | `string` | Endereço de e-mail principal do cliente |
| `Id` | `string` | Identificador único do cliente no sistema de origem (ex: plataforma e-commerce) |
| `Name` | `string` | Nome completo do cliente |
| `Phone` | `string` | Número de telefone com código do país |
| `Document` | `string` \| `null` | Documento de identificação (ex: CPF), se fornecido |
| `BirthdayDate` | `string` \| `null` | Data de nascimento (ISO 8601), se fornecida |
| `PointsBalance` | `number` | Saldo de pontos *no momento do evento* (pode não refletir o saldo após o evento) |

### Objeto Saldo de Pontos (Points Balance Object)

Contém o saldo de pontos e cashback do cliente *após* o evento ter sido processado.

```json
{
  "PointsBalance": 1650,
  "CashbackBalance": 16.50
}
```

| Campo | Tipo | Descrição |
|-------|------|-----------|
| `PointsBalance` | `number` | Saldo total de pontos *após* os efeitos do evento |
| `CashbackBalance` | `number` | Saldo total de cashback (decimal) *após* os efeitos do evento |

---

## Definições de Enum

Vários campos do payload representam tipos enumerados, enviados como **inteiros** no JSON.

### `CouponType` (Inteiro)

Indica o tipo de um cupom.

| Valor | Nome | Descrição |
|-------|------|-----------|
| `0` | FixedValue | Valor fixo (ex: R$ 10,00 de desconto) |
| `1` | Percent | Valor percentual (ex: 10% de desconto) |
| `2` | FreeShipping | Frete grátis |
| `3` | DiscountShipping | Desconto em frete |
| `4` | Others | Outros tipos (frequentemente pré-gerados) |

### `ObjectiveType` (Inteiro)

Indica a razão ou atividade que disparou o evento (ganho de pontos).

| Valor | Nome | Descrição |
|-------|------|-----------|
| `0` | Purchase | Fazer uma compra |
| `1` | Signup | Criar conta |
| `2` | Birthday | Fazer aniversário |
| `3` | Review | Fazer um review |
| `4` | Referral | Indique um amigo(a) |
| `5` | SocialMediaFollowInstagram | Siga no Instagram |
| `6` | SocialMediaFollowFacebook | Siga no Facebook |
| `7` | Quiz | Responda um Quiz |
| `8` | Custom | Objetivo Customizado |
| `9` | SocialMediaFollowLinkedin | Siga no Linkedin |
| `10` | SocialMediaFollowTikTok | Siga no TikTok |

### `PointType` (Inteiro)

Especifica a razão detalhada para uma transação de ponto.

| Valor | Nome | Descrição |
|-------|------|-----------|
| `0` | Purchase | Fez uma compra |
| `1` | Signup | Criou conta |
| `2` | Birthday | Fez aniversário |
| `3` | Ordinary | Concedido por administrador |
| `4` | Reward | Trocou por recompensa |
| `5` | Review | Fez um review |
| `6` | Refund | Reembolso de pontos |
| `7` | Expire | Pontos expirados |
| `8` | Referral | Indicou um amigo |
| `9` | SocialMediaFollowFacebook | Seguiu no Facebook |
| `10` | SocialMediaFollowInstagram | Seguiu no Instagram |
| `11` | PartialOrderRefund | Reembolso parcial de pedido |
| `12` | Quiz | Respondeu um quiz |
| `13` | CustomObjective | Pontos de objetivo personalizado |
| `14` | ReferralAffiliate | Indicação de afiliado |

### `PointAction` (Inteiro)

Indica se pontos foram adicionados ou removidos.

| Valor | Nome | Descrição |
|-------|------|-----------|
| `0` | Take | Pontos removidos ou gastos |
| `1` | Grant | Pontos adicionados ou concedidos |

---

## Garantias de Entrega & Retentativas de Webhook

| Aspecto | Descrição |
|---------|-----------|
| **Idempotência** | Cada entrega inclui um `Uuid` único. Armazene e verifique para evitar processamento duplicado. |
| **Retentativas** | Entregas falhas são retentadas automaticamente com backoff crescente. |
| **Timeout** | O sistema espera até **30 segundos** por uma resposta HTTP 2xx. |
| **Desativação** | Após **5+ falhas consecutivas**, a assinatura pode ser desativada automaticamente. |

**Recomendações:**
- Responda com HTTP 2xx idealmente em poucos segundos
- Processe o payload de forma assíncrona para evitar timeouts
- Monitore falhas e reative assinaturas conforme necessário

---

## Personalização

Ao configurar sua assinatura de webhook, você pode personalizar:

| Opção | Descrição |
|-------|-----------|
| **Corpo Personalizado** | Defina uma estrutura JSON customizada usando linguagem de template |
| **Variáveis na URL** | Use variáveis do payload na URL (ex: `https://endpoint.com/{{Customer.Id}}`) |
| **Método HTTP** | Especifique `PUT`, `POST`, etc. (padrão: `POST`) |
| **Cabeçalhos Personalizados** | Configure headers estáticos para autenticação ou roteamento |

*Consulte a interface de configuração de webhooks para detalhes sobre templates e variáveis disponíveis.*

---

## Considerações de Segurança

| Prática | Descrição |
|---------|-----------|
| **HTTPS** | Sempre use `https://` para criptografia em trânsito |
| **Sigilo do Endpoint** | Mantenha a URL do endpoint difícil de adivinhar |
| **Segredo Compartilhado** | Configure um header customizado (ex: `X-Loyalty-Secret`) com um valor secreto e valide em cada requisição recebida |

---

## Lista de Todos os Tópicos Disponíveis

Referência rápida de todos os 26 tópicos de webhook disponíveis:

### Comunicações de Ganho de Pontos

| Tópico | Descrição |
|--------|-----------|
| `Communication_EarnPurchasePoints` | Pontos por compra |
| `Communication_EarnBirthdayPoints` | Pontos por aniversário |
| `Communication_EarnSignupPoints` | Pontos por cadastro |
| `Communication_EarnReviewPoints` | Pontos por review |
| `Communication_ReferralCommunicationPoints` | Pontos por indicação |
| `Communication_EarnQuizPoints` | Pontos por quiz |
| `Communication_EarnCustomObjectivePoints` | Pontos por objetivo customizado |
| `Communication_EarnSocialMediaFollowInstagram` | Pontos por seguir no Instagram |
| `Communication_EarnSocialMediaFollowFacebook` | Pontos por seguir no Facebook |
| `Communication_EarnSocialMediaFollowLinkedin` | Pontos por seguir no Linkedin |
| `Communication_EarnSocialMediaFollowTikTok` | Pontos por seguir no TikTok |

### Outras Comunicações

| Tópico | Descrição |
|--------|-----------|
| `Communication_CouponsToUse` | Cupom disponível para uso |
| `Communication_RewardCustomRedeemNotification` | Resgate de recompensa customizada |
| `Communication_CustomerPointChangeNotification` | Alteração de pontos do cliente |
| `Communication_PointsToUse` | Pontos disponíveis para uso |
| `Communication_NotifyExpirablePoints` | Expiração de pontos |
| `Communication_RedeemPoints` | Resgate de pontos por recompensa |
| `Communication_SentOTPToCustomer` | Envio de código de validação (OTP) |
| `Communication_CustomerTierUpgradeNotification` | Cliente subiu de nível |
| `Communication_CustomerTierDowngradeNotification` | Cliente desceu de nível |

### Transações de Pontos

| Tópico | Descrição |
|--------|-----------|
| `Point_Add` | Ponto adicionado |
| `Point_Update` | Ponto atualizado |
| `Point_Removed` | Ponto removido |
| `EarnPointsReferralAffilidate` | Pontos de afiliado |

### Pedidos

| Tópico | Descrição |
|--------|-----------|
| `OrderInsert` | Pedido inserido |
| `OrderUpdate` | Pedido atualizado |

---

## Payloads de Evento por Tópico

A estrutura do objeto `Payload` depende da string `Topic`.

### Tópico: `Communication_CouponsToUse`

Enviado quando uma comunicação é disparada referente a cupons disponíveis para o cliente usar.

**Estrutura do Payload:**

```json
{
  "CouponType": 1,
  "ValidDateEnd": "2025-12-31T23:59:59Z",
  "CouponValue": 10.00,
  "CouponCode": "BEMVINDO10",
  "Customer": { ... }
}
```

| Campo | Tipo | Descrição |
|-------|------|-----------|
| `CouponType` | `number` | Tipo do cupom. Veja [CouponType](#coupontype-inteiro) |
| `ValidDateEnd` | `string` \| `null` | Data de expiração (ISO 8601), se houver |
| `CouponValue` | `number` | Valor do cupom (ex: `10.0` para 10% ou R$10,00) |
| `CouponCode` | `string` | Código para resgate |
| `Customer` | `object` | [Objeto Cliente](#objeto-cliente-customer-object) |

---

### Tópico: `Communication_RewardCustomRedeemNotification`

Enviado após um cliente resgatar pontos por uma recompensa personalizada.

**Estrutura do Payload:**

```json
{
  "Points": 500,
  "RewardDescription": "Caneca Grátis com Logo",
  "Coupon": "RESGATECAN123",
  "Customer": { ... }
}
```

| Campo | Tipo | Descrição |
|-------|------|-----------|
| `Points` | `number` | Pontos gastos no resgate |
| `RewardDescription` | `string` | Descrição da recompensa |
| `Coupon` | `string` \| `null` | Código de cupom gerado, se aplicável |
| `Customer` | `object` | [Objeto Cliente](#objeto-cliente-customer-object) |

---

### Tópicos para Comunicações de Ganho de Pontos

Estes tópicos são enviados quando um cliente ganha pontos. A estrutura varia conforme o tipo de objetivo.

**Campos Base Comuns:**

| Campo | Tipo | Descrição |
|-------|------|-----------|
| `EarnedPoints` | `number` | Pontos ganhos neste evento |
| `ObjectiveType` | `number` | Tipo de objetivo. Veja [ObjectiveType](#objectivetype-inteiro) |
| `Customer` | `object` | [Objeto Cliente](#objeto-cliente-customer-object) |

#### 1. `Communication_EarnPurchasePoints`

Ganho de pontos por uma compra.

```json
{
  "EarnedPoints": 150,
  "ObjectiveType": 0,
  "Customer": { ... },
  "CashbackEarned": 1.50,
  "ValidDate": "2026-04-15T00:00:00Z",
  "OrderDate": "2025-04-15T10:05:00Z",
  "OrderValue": 150.00,
  "PercentCashbackEarned": 0.01,
  "Date": "2025-04-15T10:05:10Z",
  "OrderId": "pedido_123",
  "PointId": 98765
}
```

| Campo Adicional | Tipo | Descrição |
|-----------------|------|-----------|
| `CashbackEarned` | `number` | Cashback ganho |
| `ValidDate` | `string` \| `null` | Expiração dos pontos/cashback |
| `OrderDate` | `string` | Data do pedido |
| `OrderValue` | `number` | Valor total do pedido |
| `PercentCashbackEarned` | `number` | Taxa de cashback (ex: `0.01` = 1%) |
| `Date` | `string` | Data do registro do evento |
| `OrderId` | `string` | ID do pedido no sistema de origem |
| `PointId` | `number` | ID interno do registro de ponto |

#### 2. `Communication_EarnBirthdayPoints`

Ganho de pontos como bônus de aniversário.

```json
{
  "EarnedPoints": 100,
  "ObjectiveType": 2,
  "Customer": { ... },
  "BirthdayPoints": 100,
  "BirthdayBonification": "Bônus Feliz Aniversário!",
  "CouponType": 1,
  "CouponCode": "NIVERPRESENTE",
  "RedeemUrl": "https://exemplo.com/resgatar-niver"
}
```

| Campo Adicional | Tipo | Descrição |
|-----------------|------|-----------|
| `BirthdayPoints` | `number` | Pontos do aniversário |
| `BirthdayBonification` | `string` \| `null` | Descrição do bônus |
| `CouponType` | `number` \| `null` | Tipo do cupom concedido |
| `CouponCode` | `string` \| `null` | Código do cupom |
| `RedeemUrl` | `string` \| `null` | URL para resgate |

#### 3. `Communication_EarnSignupPoints`

Ganho de pontos por cadastro. Usa apenas os campos base comuns.

#### 4. `Communication_EarnReviewPoints`

Ganho de pontos por review. Usa apenas os campos base comuns.

#### 5. `Communication_ReferralCommunicationPoints`

Ganho de pontos por indicação.

```json
{
  "EarnedPoints": 200,
  "ObjectiveType": 4,
  "Customer": { ... },
  "FriendName": "Maria Souza"
}
```

| Campo Adicional | Tipo | Descrição |
|-----------------|------|-----------|
| `FriendName` | `string` \| `null` | Nome do amigo indicado |

#### 6. `Communication_EarnQuizPoints`

Ganho de pontos por quiz. Usa apenas os campos base comuns.

#### 7. `Communication_EarnCustomObjectivePoints`

Ganho de pontos por objetivo personalizado. Usa apenas os campos base comuns.

#### 8-11. Comunicações de Redes Sociais

Os tópicos abaixo usam a estrutura base comum:

- `Communication_EarnSocialMediaFollowInstagram` (ObjectiveType: 5)
- `Communication_EarnSocialMediaFollowFacebook` (ObjectiveType: 6)
- `Communication_EarnSocialMediaFollowLinkedin` (ObjectiveType: 9)
- `Communication_EarnSocialMediaFollowTikTok` (ObjectiveType: 10)

---

### Tópico: `Communication_CustomerPointChangeNotification`

Enviado quando há alteração manual ou diversa no saldo de pontos.

**Estrutura do Payload:**

```json
{
  "Points": -50,
  "PointsValidDate": "01/08/2025",
  "Customer": { ... }
}
```

| Campo | Tipo | Descrição |
|-------|------|-----------|
| `Points` | `number` | Pontos da alteração (positivo = adição, negativo = subtração) |
| `PointsValidDate` | `string` | Data de expiração formatada |
| `Customer` | `object` | [Objeto Cliente](#objeto-cliente-customer-object) |

---

### Tópico: `Communication_PointsToUse`

Enviado para informar o cliente sobre seu potencial de resgate.

**Estrutura do Payload:**

```json
{
  "PointsToUse": 1500,
  "MaxValueDiscount": "R$ 15,00",
  "MaxPercentDiscount": "10%",
  "Customer": { ... }
}
```

| Campo | Tipo | Descrição |
|-------|------|-----------|
| `PointsToUse` | `number` | Total de pontos disponíveis |
| `MaxValueDiscount` | `string` | Desconto monetário máximo formatado |
| `MaxPercentDiscount` | `string` | Desconto percentual máximo formatado |
| `Customer` | `object` | [Objeto Cliente](#objeto-cliente-customer-object) |

---

### Tópico: `Communication_NotifyExpirablePoints`

Enviado para notificar sobre pontos próximos da expiração.

**Estrutura do Payload:**

```json
{
  "PointsToExpire": 250,
  "ExpirationAt": "2025-07-31T23:59:59Z",
  "ExpirationDate": "31/07/2025",
  "Customer": { ... }
}
```

| Campo | Tipo | Descrição |
|-------|------|-----------|
| `PointsToExpire` | `number` | Quantidade de pontos que expirarão |
| `ExpirationAt` | `string` | Data/hora de expiração (ISO 8601) |
| `ExpirationDate` | `string` | Data formatada para exibição |
| `Customer` | `object` | [Objeto Cliente](#objeto-cliente-customer-object) |

---

### Tópico: `Communication_RedeemPoints`

Enviado após resgate de pontos por recompensa padrão.

**Estrutura do Payload:**

```json
{
  "CouponCode": "RESGATE5OFF",
  "CouponDescription": "Cupom de Desconto R$ 5,00",
  "Points": 500,
  "Customer": { ... }
}
```

| Campo | Tipo | Descrição |
|-------|------|-----------|
| `CouponCode` | `string` | Código do cupom gerado |
| `CouponDescription` | `string` | Descrição da recompensa |
| `Points` | `number` | Pontos gastos |
| `Customer` | `object` | [Objeto Cliente](#objeto-cliente-customer-object) |

---

### Tópico: `Communication_SentOTPToCustomer`

Enviado quando um código OTP é enviado ao cliente.

> ⚠️ **Nota de Segurança:** Seja cauteloso ao processar OTPs via webhooks. Garanta que seu endpoint e lógica sejam seguros.

**Estrutura do Payload:**

```json
{
  "Otp": "123456",
  "Customer": { ... }
}
```

| Campo | Tipo | Descrição |
|-------|------|-----------|
| `Otp` | `string` | Senha de uso único enviada |
| `Customer` | `object` | [Objeto Cliente](#objeto-cliente-customer-object) |

---

### Tópicos: `Communication_CustomerTierUpgradeNotification`, `Communication_CustomerTierDowngradeNotification`

Enviado quando o nível de fidelidade do cliente muda.

**Estrutura do Payload:**

```json
{
  "TierName": "Ouro",
  "Benefits": [
    "Frete Grátis em todos os pedidos",
    "Acesso antecipado a promoções"
  ],
  "NextTierTargets": [
    "Gastar R$ 5000 nos próximos 6 meses"
  ],
  "Customer": { ... }
}
```

| Campo | Tipo | Descrição |
|-------|------|-----------|
| `TierName` | `string` | Nome do novo nível |
| `Benefits` | `array<string>` | Lista de benefícios do nível |
| `NextTierTargets` | `array<string>` | Requisitos para próximo nível (vazio se for o mais alto) |
| `Customer` | `object` | [Objeto Cliente](#objeto-cliente-customer-object) |

---

### Tópicos para Transações Diretas de Pontos

#### `Point_Add`, `Point_Update`, `Point_Removed`

Alterações no registro de pontos.

**Estrutura do Payload:**

```json
{
  "Points": 150,
  "PointType": 0,
  "PointAction": 1,
  "Customer": { ... },
  "PointsBalance": {
    "PointsBalance": 1650,
    "CashbackBalance": 16.50
  },
  "PointId": 98765
}
```

| Campo | Tipo | Descrição |
|-------|------|-----------|
| `Points` | `number` | Pontos da transação |
| `PointType` | `number` | Tipo/razão. Veja [PointType](#pointtype-inteiro) |
| `PointAction` | `number` | Ação. Veja [PointAction](#pointaction-inteiro) |
| `Customer` | `object` | [Objeto Cliente](#objeto-cliente-customer-object) |
| `PointsBalance` | `object` | [Objeto Saldo de Pontos](#objeto-saldo-de-pontos-points-balance-object) |
| `PointId` | `number` | ID interno da transação |

#### `EarnPointsReferralAffilidate`

Afiliado ganha pontos/cashback por indicação.

**Estrutura do Payload:**

```json
{
  "Points": 250,
  "CashbackReceived": 2.50,
  "OrderPlacementDate": "2025-04-14T16:20:00Z",
  "Customer": { ... },
  "PointsBalance": { ... }
}
```

| Campo | Tipo | Descrição |
|-------|------|-----------|
| `Points` | `number` | Pontos ganhos pelo afiliado |
| `CashbackReceived` | `number` | Cashback ganho pelo afiliado |
| `OrderPlacementDate` | `string` | Data do pedido do cliente indicado |
| `Customer` | `object` | [Objeto Cliente](#objeto-cliente-customer-object) (dados do afiliado) |
| `PointsBalance` | `object` | [Objeto Saldo de Pontos](#objeto-saldo-de-pontos-points-balance-object) |

---

### Tópicos para Pedidos

#### `OrderInsert`

Enviado quando um novo pedido é registrado.

#### `OrderUpdate`

Enviado quando um pedido existente é atualizado.

**Estrutura do Payload (ambos os tópicos):**

```json
{
  "Customer": { ... },
  "OrderId": "pedido_original_456",
  "BonifiQOrderId": 12345,
  "OrderPlacementDate": "2025-04-15T10:30:00Z",
  "OrderTotal": 250.00,
  "PointsBalance": { ... },
  "EarnedPoints": 250,
  "EarnedCashback": 2.50
}
```

| Campo | Tipo | Descrição |
|-------|------|-----------|
| `Customer` | `object` | [Objeto Cliente](#objeto-cliente-customer-object) |
| `OrderId` | `string` | ID do pedido no sistema de origem |
| `BonifiQOrderId` | `number` | ID interno no sistema BonifiQ |
| `OrderPlacementDate` | `string` | Data do pedido (ISO 8601) |
| `OrderTotal` | `number` | Valor total do pedido |
| `PointsBalance` | `object` | [Objeto Saldo de Pontos](#objeto-saldo-de-pontos-points-balance-object) |
| `EarnedPoints` | `number` | Pontos ganhos/associados |
| `EarnedCashback` | `number` | Cashback ganho/associado |

---

*Documentação atualizada em Dezembro de 2025.*
